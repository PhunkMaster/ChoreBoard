### Great — thanks for the detailed update. Below is the concrete plan aligned with your decisions, plus a few final clarifications to lock behavior before I start building.

---

### Confirmed architectural choices based on your update
- Packaging: single Docker image (no docker‑compose).
- Users: Django auth now; design for future Keycloak (OIDC) integration.
- Point eligibility: per‑user flag; if a chore is completed only by ineligible users, points must still be distributed to eligible users (see Q1 below to confirm exact split rule).
- Timezone: server TZ configurable via environment variable; use as source of truth for “midnight” and all evaluations. Default `America/Chicago`.
- Recurrence:
  - Daily/weekly/cron and every N days supported.
  - Weekly chores “activate” (become due) at midnight of their target day and become overdue at the following midnight if unfinished.
  - Every N days: explicit start date per chore; if finished late, next due = completion time + N days (shifts schedule forward).
  - Complex cron rules (e.g., 1st and 3rd Friday, Mo+We): supported via rules engine (rrule) layered on cron-like expressions.
- Distribution at 17:30 by default, per‑chore override allowed.
  - Selection priorities updated:
    1) Eligible users only (from chore’s eligible list if set; else all point‑eligible users)
    2) Exclude last period’s completers
    3) Prefer users with the fewest force‑assignments today
    4) Break ties randomly
  - If no eligible user remains → leave unassigned, display “purple” state on the board with the reason, and alert admin.
- Difficult chores: when auto‑assigning, avoid giving a second difficult chore to a user who already completed a difficult chore earlier that day.
- Claims: max 1 per user per server day; undo of a claimed chore restores the claim allowance.
- Points & naming:
  - Equal split only among helpers; round at transaction to 2 decimals (half‑up).
  - Conversion rate is admin‑only (100 points per $1), not shown to regular users.
  - Points label is configurable; default singular “Phil”, plural “Phils”.
  - Undo removes only the exact points previously awarded for that completion; no extra penalty.
- Streaks: global to the household; resets if any chore is overdue that week (admin can override).
- Logs: evaluation and action logs retained 30 days.
- UI: Django + HTMX + Tailwind, touch‑optimized, dark theme; green for on‑time, red for overdue, purple for assignment issues; cards show last completion time and last completer.
- Public board: non‑logged‑in users can interact; completion shows a confirmation dialog to select who completed (default to the assigned user if applicable) and optionally add additional helpers.
- Notifications: architect webhooks; implement 1–2 adapters in this iteration if you pick which (Discord/Telegram/Home Assistant).
- New requirements:
  - “Late” chore status (distinct from “overdue”).
  - REST API to list a user’s outstanding late chores.
  - Dependency recurrence: spawn/populate a chore instance after another chore is completed.

---

### Behavioral details I propose (please confirm)
1) Points distribution when only ineligible users complete a chore
- Clarify: Should points be split among all point‑eligible users in the system equally, even if they didn’t help? Or should the completion be recorded with zero points because no eligible helpers participated? Your note suggests the former (distribute to all eligible users). Please confirm.

2) “No negative points” on undo
- Do you want weekly and all‑time totals floored at 0? Example: a user has 0 current points, admin undoes a completion worth 5 Phils → should the user show 0 (floor) or −5? I suggest floor to 0 for both weekly and all‑time.

3) Definition of “late”
- Proposal: add optional per‑chore `late_after_time` (HH:MM, server TZ). If an instance is not completed by that time (but before midnight), it is “late” (yellow/orange badge in UI or a distinct icon), but still not “overdue.” Defaults to None (no “late” concept). Do you want a global default (e.g., 17:30) if a chore doesn’t set one?

4) REST API for outstanding late chores
- Endpoint: `GET /api/users/{id or username}/late-chores` returns the chore instances for today currently in “late” state and not completed.
- Include optional `include_overdue=true` to include overdue; default false. OK?

5) Dependency recurrence (“after another chore”)
- Model: `ChoreDependency(chore=Child, depends_on=Parent, offset_hours=0)`
- Behavior: when a `Parent` instance is completed, immediately create a `Child` instance (for the same day at the next evaluation tick), optionally delayed by `offset_hours`. If the parent completion is undone, the child instance remains but is flagged in logs, or should the child be deleted/rolled back if still open? Preference?
- Cycle detection: we’ll prevent circular dependencies in admin.

6) Public kiosk protections
- Since non‑logged‑in users can complete chores, should we:
  - Require a simple household PIN for admin actions (undo, force assign, conversion) and for changing helper selections? (Public completion still allowed but “admin” actions blocked.)
  - Or keep admin functions behind Django login only, while completion remains public? I recommend the latter + a lightweight kiosk PIN to access the admin shortcut on the kiosk.

7) Notifications
- Which integrations do you want first? Discord webhook is simplest; Telegram Bot and Home Assistant webhook next. Pick 1–2 for this iteration.

8) Complex schedules
- For patterns like “1st and 3rd Friday,” I’ll implement using `dateutil.rrule` with an editor UI. Confirm this is acceptable.

9) Tailwind build in Docker
- I’ll use the standalone Tailwind CLI during image build to produce static CSS (no Node runtime at run time). OK?

---

### Data model (finalized spec, incorporating your updates)
- `Chore(id, name, description, tags=[undesirable,difficult], schedule_type, n_days, weekday(s), cron_expr, rrule_json, start_date, default_distribution_time, fixed_assignee, points, late_after_time, active)`
- `ChoreEligibility(chore, user)` — limits rotation for undesirable chores and assignment pool.
- `ChoreDependency(chore, depends_on, offset_hours)` — spawn child instance after parent completion.
- `ChoreInstance(id, chore, period_start, period_end, due_at, status=[pool,assigned,completed], assigned_to, is_overdue, is_late, last_transition_at, forced_assigned_at, reason_code)`
- `Completion(id, instance, completed_at)`
- `CompletionShare(completion, user, share, points_awarded)` — equal share only at creation time.
- `PointsLedger(id, user, amount, kind=[award,undo,adjustment], related_completion, created_at)` — amount rounded to 2 decimals; totals floored to 0 if you approve.
- `RotationState(chore, last_completers (list), daily_force_assign_counts (by date))`
- `Streak(id, current_count, last_week_start, last_week_end, updated_at)`
- `EvaluationLog(id, at, kind=[midnight,distribution,manual], payload)` (30d retention)
- `ActionLog(id, at, action=[complete,undo,claim,assign,auto_assign,reassign], payload)` (30d retention)

---

### Scheduling inside a single Docker image
- Use `django-apscheduler` (APScheduler) with the Django DB job store to persist jobs.
- Jobs:
  - Midnight: close previous period, mark overdue, and generate today’s instances.
  - Minutely (cheap): check any chores that hit their distribution time in the past minute and process auto‑assignment; also recompute “late” flags.
  - Weekly (Sunday midnight): snapshot and reset weekly totals; compute perfect week flag for “tooltime.”
- APScheduler runs in the web process via a small startup hook; idempotent operations ensure safe restarts and multiple workers.

---

### Initial REST API (public-safe defaults)
- `GET /api/board` — current board (pool, assigned, overdue, purple issues)
- `POST /api/instances/{id}/complete` — submit completion with selected user(s) (public)
- `POST /api/instances/{id}/undo` — admin‑only (login or PIN)
- `POST /api/instances/{id}/claim` — public (enforces 1/day limit), requires selecting a user
- `GET /api/users/{id}/late-chores?include_overdue=false` — as discussed
- `GET /api/leaderboard?range=weekly|alltime`

---

### Environment variables (draft)
- `DJANGO_SECRET_KEY`, `DJANGO_DEBUG=false`, `DJANGO_ALLOWED_HOSTS`.
- `APP_TIMEZONE` (e.g., `America/Chicago`).
- `DEFAULT_DISTRIBUTION_TIME=17:30`.
- `POINTS_LABEL_SINGULAR=Phil`, `POINTS_LABEL_PLURAL=Phils`.
- `RETENTION_DAYS=30`.
- Optional: `KIOSK_ADMIN_PIN` for kiosk admin actions.
- Optional: webhook URLs for Discord/Telegram/Home Assistant.

---

### Next steps
- Please confirm answers to the numbered questions (Q1–Q9). Once confirmed, I’ll scaffold the Django app, models, migrations, job scheduler setup, REST endpoints, and the responsive dark UI in a single Docker image, and we can iterate on the board/flows quickly.
