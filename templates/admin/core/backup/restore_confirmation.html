{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Restore Selective Backup - Confirmation{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .restore-warning {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .restore-danger {
        background-color: #f8d7da;
        border: 2px solid #dc3545;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .backup-list {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }

    .backup-item {
        padding: 10px;
        margin: 5px 0;
        border: 1px solid #ced4da;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .backup-item:hover {
        background-color: #e9ecef;
    }

    .backup-item.selected {
        background-color: #d1ecf1;
        border-color: #17a2b8;
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-danger:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-block;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<h1>üîÑ Restore Selective Backup</h1>

<div class="restore-danger">
    <h2 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è WARNING: DESTRUCTIVE OPERATION</h2>
    <p><strong>This action will permanently delete the following data:</strong></p>
    <ul>
        <li>‚ùå All ChoreInstances (including invalid instances)</li>
        <li>‚ùå All Completions and CompletionShares</li>
        <li>‚ùå All PointsLedger entries</li>
        <li>‚ùå All Arcade Sessions and Completions</li>
        <li>‚ùå All WeeklySnapshots</li>
        <li>‚ùå All Streaks</li>
        <li>‚ùå All ActionLogs</li>
    </ul>
    <p><strong>All user points will be reset to zero.</strong></p>
</div>

<div class="restore-warning">
    <h3 style="color: #856404; margin-top: 0;">‚úÖ What will be preserved:</h3>
    <ul>
        <li>‚úÖ User accounts (passwords intact)</li>
        <li>‚úÖ Chore definitions</li>
        <li>‚úÖ Chore dependencies and eligibility rules</li>
        <li>‚úÖ Settings and configuration</li>
        <li>‚úÖ Arcade high scores</li>
    </ul>
</div>

<h2>Select Backup File to Restore:</h2>

<div class="backup-list">
    {% if backup_files %}
        <p>Click on a backup file to select it:</p>
        <form method="post" id="restore-form">
            {% csrf_token %}
            <input type="hidden" name="confirmed" value="yes">
            <input type="hidden" name="backup_file" id="selected-backup" value="">

            {% for backup in backup_files %}
            <div class="backup-item" onclick="selectBackup('{{ backup.filename }}', this)">
                <strong>üì¶ {{ backup.filename }}</strong><br>
                <small>Created: {{ backup.created }} | Size: {{ backup.size|filesizeformat }}</small>
            </div>
            {% endfor %}
        </form>
    {% else %}
        <p style="color: #856404;">‚ö†Ô∏è No selective backup files found.</p>
        <p>Create a selective backup first using the "Create selective backup" action from the Backup admin page.</p>
    {% endif %}
</div>

{% if backup_files %}
<div class="restore-danger">
    <h3 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è Final Confirmation</h3>
    <p><strong>Before proceeding, ensure you understand:</strong></p>
    <ol>
        <li>All completion history will be lost</li>
        <li>All user points will be reset to zero</li>
        <li>New chore instances will be created at the next midnight evaluation</li>
        <li>This operation cannot be undone without a full database backup</li>
    </ol>
    <p><strong>Type "I UNDERSTAND" in the box below to enable the restore button:</strong></p>
    <input type="text" id="confirmation-text" placeholder="Type 'I UNDERSTAND'"
           style="width: 100%; padding: 10px; font-size: 16px; margin: 10px 0; border: 2px solid #dc3545; border-radius: 4px;">
</div>

<div class="button-group">
    <button type="button" class="btn-danger" id="restore-btn" disabled onclick="confirmRestore()">
        üîÑ Restore Backup (Irreversible)
    </button>
    <a href="{% url 'admin:core_backup_changelist' %}" class="btn-secondary">
        ‚Üê Cancel and Go Back
    </a>
</div>
{% else %}
<div class="button-group">
    <a href="{% url 'admin:core_backup_changelist' %}" class="btn-secondary">
        ‚Üê Go Back
    </a>
</div>
{% endif %}

<script>
let selectedBackupFile = null;

function selectBackup(filename, element) {
    // Remove selection from all items
    document.querySelectorAll('.backup-item').forEach(item => {
        item.classList.remove('selected');
    });

    // Add selection to clicked item
    element.classList.add('selected');
    selectedBackupFile = filename;
    document.getElementById('selected-backup').value = filename;

    // Re-check if restore button should be enabled
    updateRestoreButton();
}

function updateRestoreButton() {
    const confirmationText = document.getElementById('confirmation-text').value.trim();
    const restoreBtn = document.getElementById('restore-btn');

    if (confirmationText === 'I UNDERSTAND' && selectedBackupFile) {
        restoreBtn.disabled = false;
    } else {
        restoreBtn.disabled = true;
    }
}

function confirmRestore() {
    if (!selectedBackupFile) {
        alert('Please select a backup file first.');
        return;
    }

    const confirmationText = document.getElementById('confirmation-text').value.trim();
    if (confirmationText !== 'I UNDERSTAND') {
        alert('Please type "I UNDERSTAND" to confirm.');
        return;
    }

    if (confirm(`Are you ABSOLUTELY SURE you want to restore from ${selectedBackupFile}?\n\nThis will DELETE all chore instances, completions, and points data!\n\nClick OK to proceed or Cancel to abort.`)) {
        document.getElementById('restore-form').submit();
    }
}

// Enable/disable restore button based on confirmation text
document.getElementById('confirmation-text').addEventListener('input', updateRestoreButton);
</script>
{% endblock %}
